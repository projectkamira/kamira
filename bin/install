#!/usr/bin/env coffee
program = require 'commander'
_ = require 'underscore'
mongoose = require('mongoose')


program.version('0.0.1')
  .option('-d, --database <path>', 'database name')
  .parse(process.argv)

Measure = require('../models/measure')(mongoose, db).model
# Util = require("../models/util")(mongoose, db).model
MeasureAnalyzer = require '../lib/measure-analyzer'


db = mongoose.createConnection "mongodb://localhost/#{program.database}", ->
  console.log "Connected to the #{db.name} MongoDB collection"
analyzer = new MeasureAnalyzer(utils, stage: "stage2")

# Util.find (err, utils) ->
#   console.log utils[0]


Measure.find (err, measures) ->
  unless err?
    # for measure in measure
    measure = measures[0]
    mappingFunction = measure.map_fn.replace(/<%=.*effective_date.*%>/, 1347983662).replace('<%= init_js_frameworks %>', '')
    analysis = analyzer.analyze(mappingFunction, measure.nqf_id)
    # console.log(analysis.complexity)